<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ongod Gadget Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; }
    .container { max-width: 1100px; margin: 40px auto; background: #fff; border-radius: 14px; box-shadow: 0 4px 24px #0002; padding: 32px 20px; }
    h1 { margin-top: 0; font-size: 2.2rem; color: #222; }
    .refresh-btn { margin-bottom: 20px; padding: 8px 16px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer;}
    .refresh-btn:hover { background: #218838; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #e0e0e0; padding: 10px 8px; }
    th { background: #f8f9fa; color: #333; font-weight: 600; }
    tr:nth-child(even) { background: #f6f8fa; }
    tr:hover { background: #eaf6ff; }
    .action-btn { padding: 5px 12px; margin: 0 2px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.98rem;}
    .confirm-btn { background: #007bff; color: #fff; }
    .delete-btn { background: #dc3545; color: #fff; }
    .confirm-btn:hover { background: #0056b3; }
    .delete-btn:hover { background: #a71d2a; }
    .pay-btn { background: #28a745; color: #fff; }
    .pay-btn:hover { background: #1e7e34; }
    .unpaid-btn { background: #ffc107; color: #333; }
    .unpaid-btn:hover { background: #e0a800; }
    #adminNotification {
      display:none;
      position:fixed;
      top:24px;
      right:32px;
      background:#333;
      color:#fff;
      padding:14px 28px;
      border-radius:6px;
      z-index:9999;
      font-size:1.1rem;
      box-shadow:0 2px 8px #0003;
      min-width:220px;
      text-align:center;
    }
    @media (max-width: 900px) {
      .container { padding: 10px; }
      table, th, td { font-size: 13px; }
    }
    @media (max-width: 600px) {
      .container { padding: 2px; }
      table, th, td { font-size: 12px; }
      h1 { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <div id="adminNotification"></div>
  <div class="container">
    <h1>Ongod Gadget Admin Panel</h1>
    <button class="refresh-btn" onclick="fetchOrders()">Refresh Orders</button>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Items</th>
          <th>Details</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="orders-table">
        <tr><td colspan="10" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  <script>
    // Replace with your SheetBest API URL
    const ORDERS_URL = 'https://api.sheetbest.com/sheets/6b0edbce-49b7-4baf-8bb6-a5c1f6879fa2';

    function showAdminNotification(msg, color = "#333") {
      const n = document.getElementById('adminNotification');
      n.textContent = msg;
      n.style.background = color;
      n.style.display = 'block';
      clearTimeout(window._adminNotifTimeout);
      window._adminNotifTimeout = setTimeout(() => { n.style.display = 'none'; }, 3000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }

    function fetchOrders() {
      const tbody = document.getElementById('orders-table');
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Loading...</td></tr>';
      fetch(ORDERS_URL)
        .then(res => res.json())
        .then(data => {
          if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">No orders found.</td></tr>';
            return;
          }
          tbody.innerHTML = '';
          data.slice().reverse().forEach((order, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${formatDate(order.date)}</td>
              <td>${order.type || ''}</td>
              <td>${order.name || ''}</td>
              <td>${order.phone || ''}</td>
              <td>${order.email || ''}</td>
              <td>${order.items || ''}</td>
              <td>${order.details || ''}</td>
              <td>${order.total ? ('#' + order.total) : ''}</td>
              <td id="status-${idx}">${order.status || ''}</td>
              <td>
                <button class="action-btn confirm-btn" onclick="markAsConfirmed(${idx}, this)">Confirm</button>
                <button class="action-btn delete-btn" onclick="deleteOrder(${idx}, this)">Delete</button>
              </td>
            `;
            tr.dataset.orderIndex = idx;
            tbody.appendChild(tr);
          });
          window._ordersData = data.slice().reverse(); // Store for actions
        })
        .catch(() => {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Failed to load orders.</td></tr>';
        });
    }

    // Mark as Confirmed (status update)
    function markAsConfirmed(idx, btn) {
      if (!window._ordersData || !window._ordersData[idx]) return;
      const order = window._ordersData[idx];
      if (order.status === 'Confirmed') {
        showAdminNotification('Order already confirmed.', "#ffc107");
        return;
      }
      // PATCH request to SheetBest to update status
      fetch(ORDERS_URL, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify([
          {
            "date": order.date,
            "email": order.email
          },
          {
            "status": "Confirmed",
            "message": "Your order has been confirmed by admin."
          }
        ])
      }).then(() => {
        document.getElementById('status-' + idx).textContent = 'Confirmed';
        btn.disabled = true;
        btn.textContent = 'Confirmed';
        btn.classList.remove('confirm-btn');
        btn.classList.add('pay-btn');
        showAdminNotification("User will see: Order confirmed!", "#28a745");
      }).catch(() => {
        showAdminNotification('Failed to update order status.', "#dc3545");
      });
    }

    // Delete order (remove from SheetBest)
    function deleteOrder(idx, btn) {
      if (!window._ordersData || !window._ordersData[idx]) return;
      if (!confirm('Are you sure you want to delete this order?')) return;
      const order = window._ordersData[idx];
      // DELETE request to SheetBest (by unique fields)
      fetch(ORDERS_URL, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          "date": order.date,
          "email": order.email
        })
      }).then(() => {
        btn.closest('tr').remove();
        showAdminNotification("Order deleted.", "#333");
      }).catch(() => {
        showAdminNotification('Failed to delete order.', "#dc3545");
      });
    }

    fetchOrders();
  </script>
</body>
</html>