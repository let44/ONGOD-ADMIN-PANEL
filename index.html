<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ongod Gadget Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6fa; margin: 0; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 10px; box-shadow: 0 2px 16px #0001; }
    h2 { text-align: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 18px; background: #fff; }
    th, td { padding: 10px 6px; border: 1px solid #eaeaea; text-align: left; }
    th { background: #f5f5f5; }
    tr:nth-child(even) { background: #fafbfc; }
    .status.confirmed { color: #28a745; font-weight: bold; }
    .status.rejected { color: #dc3545; font-weight: bold; }
    .status.deleted { color: #888; font-weight: bold; }
    .actions button { margin-right: 6px; padding: 6px 14px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .actions .confirm { background: #28a745; color: #fff; }
    .actions .reject { background: #dc3545; color: #fff; }
    .actions .delete { background: #888; color: #fff; }
    .actions .message { background: #007bff; color: #fff; }
    .notification { position: fixed; top: 24px; right: 24px; background: #333; color: #fff; padding: 16px 28px; border-radius: 8px; font-size: 1.1rem; display: none; z-index: 9999; }
    #msgModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#0005; z-index:4001; align-items:center; justify-content:center; }
    #msgModalBox { background:#fff; padding:24px 18px; border-radius:8px; max-width:400px; margin:80px auto; position:relative; box-shadow:0 2px 16px #0002; }
    #msgModalBox h3 { margin-top:0; }
    #msgModalBox textarea { width: 100%; min-height: 60px; margin-bottom: 12px; }
    #msgModalBox button { margin-right: 8px; }
    @media (max-width: 700px) {
      .container { max-width: 99vw; padding: 6px 1vw; }
      table, thead, tbody, th, td, tr { display: block; width: 100%; }
      thead tr { display: none; }
      tr { margin-bottom: 18px; border-radius: 8px; box-shadow: 0 1px 6px #0001; background: #fff; }
      td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 48%;
        min-height: 36px;
        font-size: 15px;
      }
      td:last-child { border-bottom: none; }
      td:before {
        position: absolute;
        top: 10px; left: 10px; width: 44%;
        white-space: nowrap;
        font-weight: bold;
        color: #007bff;
        font-size: 13px;
        content: attr(data-label);
      }
      .actions { display: flex; flex-wrap: wrap; gap: 8px; }
      .actions button { margin-bottom: 6px; width: 100%; min-width: 90px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Admin Order List</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Items</th>
          <th>Details</th>
          <th>Total</th>
          <th>Status</th>
          <th>Message</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="ordersTable">
        <!-- Orders will load here -->
      </tbody>
    </table>
  </div>

  <!-- Notification -->
  <div class="notification" id="adminNotification"></div>

  <!-- Message Modal -->
  <div id="msgModal">
    <div id="msgModalBox">
      <h3>Send Message to User</h3>
      <div id="msgOrderInfo"></div>
      <textarea id="msgText" placeholder="Type your message..."></textarea>
      <div>
        <button onclick="sendAdminMessage('confirmed')">Confirm</button>
        <button onclick="sendAdminMessage('rejected')">Reject</button>
        <button onclick="sendAdminMessage('deleted')">Delete</button>
        <button onclick="closeMsgModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Use the same sheet as user side!
    const SHEETBEST_URL = 'https://api.sheetbest.com/sheets/bc256516-2eec-4676-8df9-0cacbf344615';
    let ordersData = [];
    let currentIdx = null;

    function showNotification(msg, color="#333") {
      const n = document.getElementById('adminNotification');
      n.textContent = msg;
      n.style.background = color;
      n.style.display = 'block';
      clearTimeout(window._notifTimeout);
      window._notifTimeout = setTimeout(() => { n.style.display = 'none'; }, 3000);
    }

    function fetchOrders() {
      document.getElementById('ordersTable').innerHTML = '<tr><td colspan="11">Loading...</td></tr>';
      fetch(SHEETBEST_URL)
        .then(res => res.json())
        .then(data => {
          ordersData = data;
          if (!data.length) {
            document.getElementById('ordersTable').innerHTML = '<tr><td colspan="11">No orders yet.</td></tr>';
            return;
          }
          let html = '';
          data.slice().reverse().forEach((order, idx) => {
            html += `<tr>
              <td data-label="Date">${order.date ? order.date.replace('T', ' ').slice(0, 16) : ''}</td>
              <td data-label="Type">${order.type || ''}</td>
              <td data-label="Name">${order.name || ''}</td>
              <td data-label="Phone">${order.phone || ''}</td>
              <td data-label="Email">${order.email || ''}</td>
              <td data-label="Items">${order.items || ''}</td>
              <td data-label="Details">${order.details || ''}</td>
              <td data-label="Total">${order.total ? Number(order.total).toLocaleString() : ''}</td>
              <td data-label="Status" class="status ${order.status || ''}">${order.status || ''}</td>
              <td data-label="Message">${order.message || ''}${order.admin_message ? `<br><b style="color:#6366f1;">[ADMIN]</b> ${order.admin_message}` : ''}</td>
              <td data-label="Action" class="actions">
                <button class="confirm" onclick="openMsgModal(${ordersData.length-1-idx})">Update/Message</button>
              </td>
            </tr>`;
          });
          document.getElementById('ordersTable').innerHTML = html;
        });
    }

    function openMsgModal(index) {
      currentIdx = index;
      const order = ordersData[index];
      document.getElementById('msgOrderInfo').innerHTML = `<b>Name:</b> ${order.name}<br><b>Email:</b> ${order.email}`;
      document.getElementById('msgText').value = '';
      document.getElementById('msgModal').style.display = 'flex';
    }
    function closeMsgModal() {
      document.getElementById('msgModal').style.display = 'none';
    }

    // When admin sends a message or changes status, POST to the same sheet
    function sendAdminMessage(status) {
      const order = ordersData[currentIdx];
      const msg = document.getElementById('msgText').value.trim();
      fetch(SHEETBEST_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          date: new Date().toISOString(),
          email: order.email,
          admin_message: msg ? msg : `Your order has been ${status}.`,
          status: status
        })
      }).then(() => {
        showNotification(`Order ${status} and message sent.`, "#007bff");
        closeMsgModal();
        fetchOrders();
      });
    }

    document.addEventListener('DOMContentLoaded', fetchOrders);
  </script>
</body>
</html>